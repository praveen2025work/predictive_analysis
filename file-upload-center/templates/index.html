<!DOCTYPE html>
<html>
<head>
    <title>File Upload Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container mt-5">
        <h2>File Upload Center</h2>
        <p>Logged in as: {{ current_user.id }} | <a href="{{ url_for('logout') }}">Logout</a></p>
        <input type="file" id="fileInput" class="form-control mb-3">
        <button onclick="uploadFile()" class="btn btn-primary">Upload</button>
        
        <h3 class="mt-4">Uploaded Files</h3>
        <ul id="fileList" class="list-group mb-4"></ul>
        
        <h3>Upload History</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Filename</th>
                    <th>Size (bytes)</th>
                    <th>Upload Time</th>
                    <th>User ID</th>
                </tr>
            </thead>
            <tbody id="uploadHistory"></tbody>
        </table>
    </div>
    <script>
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const result = await res.json();
                if (res.ok) {
                    alert(result.message);
                    loadFiles();
                    loadUploadHistory();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('Error uploading file');
            }
        }

        async function loadFiles() {
            try {
                const res = await fetch('/files');
                if (res.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const files = await res.json();
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `${file} <a href="/download/${file}" class="btn btn-sm btn-success">Download</a>`;
                    fileList.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        async function loadUploadHistory() {
            try {
                const res = await fetch('/uploads');
                if (res.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const uploads = await res.json();
                const historyTable = document.getElementById('uploadHistory');
                historyTable.innerHTML = '';
                uploads.forEach(upload => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${upload.id}</td>
                        <td>${upload.filename}</td>
                        <td>${upload.size}</td>
                        <td>${upload.upload_time}</td>
                        <td>${upload.user_id}</td>
                    `;
                    historyTable.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading upload history:', error);
            }
        }

        window.onload = () => {
            loadFiles();
            loadUploadHistory();
        };
    </script>
</body>
</html>